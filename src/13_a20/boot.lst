     1                                  %include    "../include/define.s"
     2                              <1> BOOT_LOAD   equ     0x7C00
     3                              <1> BOOT_SIZE   equ     (1024 * 8)
     4                              <1> SECT_SIZE   equ     (512)
     5                              <1> BOOT_SECT   equ     (BOOT_SIZE / SECT_SIZE)
     6                              <1> E820_RECORD_SIZE    equ     20
     2                                  %include    "../include/macro.s"
     3                              <1> %macro  cdecl 1-*.nolist
     4                              <1> 
     5                              <1>     %rep %0 - 1
     6                              <1>         push    %{-1:-1}
     7                              <1>         %rotate -1
     8                              <1>     %endrep
     9                              <1>     %rotate -1
    10                              <1>     call    %1
    11                              <1> 
    12                              <1>     %if 1 < %0
    13                              <1>         add     sp, (__BITS__ >> 3) * (%0 - 1)
    14                              <1>     %endif
    15                              <1> %endmacro
    16                              <1> 
    17                              <1> struc drive
    18 00000000 ????                <1>     .no     resw    1
    19 00000002 ????                <1>     .cyln   resw    1
    20 00000004 ????                <1>     .head   resw    1
    21 00000006 ????                <1>     .sect   resw    1
    22                              <1> endstruc
     3                                  
     4                                      ORG         BOOT_LOAD
     5                                  
     6                                  entry:
     7 00000000 EB58                        jmp     ipl
     8                                  
     9 00000002 90<rep 58h>                 times   90 - ($ - $$) db 0x90
    10                                  
    11                                  ipl:
    12 0000005A FA                          cli
    13 0000005B B80000                      mov     ax, 0x0000
    14 0000005E 8ED8                        mov     ds, ax
    15 00000060 8EC0                        mov     es, ax
    16 00000062 8ED0                        mov     ss, ax
    17 00000064 BC007C                      mov     sp, BOOT_LOAD
    18 00000067 FB                          sti
    19 00000068 8816[C400]                  mov     [BOOT + drive.no], dl
    20                                  
    21 0000006C 68[9900]E85C0083C4-         cdecl   puts, .s0
    21 00000074 02                 
    22                                  
    23 00000075 BB0F00                      mov     bx, BOOT_SECT - 1
    24 00000078 B9007E                      mov     cx, BOOT_LOAD + SECT_SIZE
    25                                  
    26 0000007B 515368[C400]E8A900-         cdecl   read_chs, BOOT, bx, cx
    26 00000083 83C406             
    27                                  
    28 00000086 39D8                        cmp     ax, bx
    29                                  .10Q:
    30 00000088 740C                        jz     .10E
    31                                  .10T:
    32 0000008A 68[B100]E83E0083C4-         cdecl   puts, .e0
    32 00000092 02                 
    33 00000093 E85700                      call    reboot
    34                                  .10E:
    35 00000096 E96105                      jmp     stage_2
    36                                  
    37                                  
    38 00000099 426F6F74696E672E2E-     .s0 db  "Booting...", 0x0A, 0x0D, 0
    38 000000A2 2E0A0D00           
    39 000000A6 2D2D2D2D2D2D2D2D0A-     .s1 db  "--------", 0x0A, 0x0D, 0
    39 000000AF 0D00               
    40 000000B1 4572726F723A736563-     .e0 db  "Error:sector read", 0
    40 000000BA 746F72207265616400 
    41                                  
    42 000000C3 00                      ALIGN 2, db 0
    43                                  BOOT:
    44                                      istruc  drive
    45 000000C4 0000                            at  drive.no,   dw  0
    46 000000C6 0000                            at  drive.cyln, dw  0
    47 000000C8 0000                            at  drive.head, dw  0
    48 000000CA 0200                            at  drive.sect, dw  2
    49                                      iend
    50 000000CC 0000                    .DRIVE:     dw  0
    51                                  
    52                                  %include    "../modules/real/puts.s"
    53                              <1> puts:
    54 000000CE 55                  <1>     push    bp
    55 000000CF 89E5                <1>     mov     bp, sp
    56 000000D1 50                  <1>     push    ax
    57 000000D2 53                  <1>     push    bx
    58 000000D3 56                  <1>     push    si
    59                              <1> 
    60 000000D4 8B7604              <1>     mov     si, [bp + 4]
    61                              <1> 
    62 000000D7 B40E                <1>     mov     ah, 0x0E
    63 000000D9 BB0000              <1>     mov     bx, 0x0000
    64 000000DC FC                  <1>     cld
    65                              <1> 
    66                              <1> .10L:
    67 000000DD AC                  <1>     lodsb
    68 000000DE 3C00                <1>     cmp     al, 0
    69 000000E0 7404                <1>     je      .10E
    70                              <1> 
    71 000000E2 CD10                <1>     int     0x10
    72 000000E4 EBF7                <1>     jmp     .10L
    73                              <1> 
    74                              <1> .10E:
    75 000000E6 5E                  <1>     pop     si
    76 000000E7 5B                  <1>     pop     bx
    77 000000E8 58                  <1>     pop     ax
    78                              <1> 
    79 000000E9 89EC                <1>     mov     sp, bp
    80 000000EB 5D                  <1>     pop     bp
    81                              <1> 
    82 000000EC C3                  <1>     ret
    53                                  %include    "../modules/real/reboot.s"
    54                              <1> reboot:
    55 000000ED 68[0901]E8DBFF83C4- <1>     cdecl   puts, .s0
    55 000000F5 02                  <1>
    56                              <1> 
    57                              <1> .10L:
    58 000000F6 B410                <1>     mov     ah, 0x10
    59 000000F8 CD16                <1>     int     0x16
    60                              <1> 
    61 000000FA 3C20                <1>     cmp     al, ' '
    62 000000FC 75F8                <1>     jne     .10L
    63                              <1> 
    64 000000FE 68[2701]E8CAFF83C4- <1>     cdecl   puts, .s1
    64 00000106 02                  <1>
    65                              <1> 
    66 00000107 CD19                <1>     int     0x19
    67                              <1> 
    68 00000109 0A0D50757368205370- <1> .s0     db  0x0A, 0x0D, "Push Space key to reboot...", 0
    68 00000112 616365206B65792074- <1>
    68 0000011B 6F207265626F6F742E- <1>
    68 00000124 2E2E00              <1>
    69 00000127 0A0D0A0D00          <1> .s1     db  0x0A, 0x0D, 0x0A, 0x0D, 0
    54                                  %include    "../modules/real/read_chs.s"
    55                              <1> read_chs:
    56 0000012C 55                  <1>     push    bp
    57 0000012D 89E5                <1>     mov     bp, sp
    58 0000012F 6A03                <1>     push    3
    59 00000131 6A00                <1>     push    0
    60                              <1> 
    61 00000133 53                  <1>     push    bx
    62 00000134 51                  <1>     push    cx
    63 00000135 52                  <1>     push    dx
    64 00000136 06                  <1>     push    es
    65 00000137 56                  <1>     push    si
    66                              <1> 
    67 00000138 8B7604              <1>     mov     si, [bp + 4]
    68                              <1> 
    69 0000013B 8A6C02              <1>     mov     ch, [si + drive.cyln + 0]
    70 0000013E 8A4C03              <1>     mov     cl, [si + drive.cyln + 1]
    71 00000141 C0E106              <1>     shl     cl, 6
    72 00000144 0A4C06              <1>     or      cl, [si + drive.sect]
    73                              <1> 
    74 00000147 8A7404              <1>     mov     dh, [si + drive.head]
    75 0000014A 8A14                <1>     mov     dl, [si + 0]
    76 0000014C B80000              <1>     mov     ax, 0x0000
    77 0000014F 8EC0                <1>     mov     es, ax
    78 00000151 8B5E08              <1>     mov     bx, [bp + 8]
    79                              <1> 
    80                              <1> .10L:
    81 00000154 B402                <1>     mov     ah, 0x02
    82 00000156 8A4606              <1>     mov     al, [bp + 6]
    83                              <1> 
    84 00000159 CD13                <1>     int     0x13
    85 0000015B 7304                <1>     jnc     .11E
    86                              <1> 
    87 0000015D B000                <1>     mov     al, 0
    88 0000015F EB0C                <1>     jmp     .10E
    89                              <1> .11E:
    90 00000161 3C00                <1>     cmp     al, 0
    91 00000163 7508                <1>     jne     .10E
    92                              <1> 
    93 00000165 B80000              <1>     mov     ax, 0
    94 00000168 FF4EFE              <1>     dec     word [bp - 2]
    95 0000016B 75E7                <1>     jnz     .10L
    96                              <1> 
    97                              <1> .10E:
    98 0000016D B400                <1>     mov     ah, 0
    99                              <1> 
   100 0000016F 5E                  <1>     pop     si
   101 00000170 07                  <1>     pop     es
   102 00000171 5A                  <1>     pop     dx
   103 00000172 59                  <1>     pop     cx
   104 00000173 5B                  <1>     pop     bx
   105                              <1> 
   106 00000174 89EC                <1>     mov     sp, bp
   107 00000176 5D                  <1>     pop     bp
   108 00000177 C3                  <1>     ret
    55                                  
    56 00000178 00<rep 86h>                 times   510 - ($ - $$) db 0x00
    57 000001FE 55AA                        db      0x55, 0xAA
    58                                  
    59                                  FONT:
    60 00000200 0000                    .seg:   dw  0
    61 00000202 0000                    .off:   dw  0
    62                                  ACPI_DATA:
    63 00000204 00000000                .adr:   dd  0
    64 00000208 00000000                .len:   dd  0
    65                                  
    66                                  %include    "../modules/real/itoa.s"
    67                              <1> itoa:
    68 0000020C 55                  <1>     push    bp
    69 0000020D 89E5                <1>     mov     bp, sp
    70                              <1>     
    71 0000020F 50                  <1>     push    ax
    72 00000210 53                  <1>     push    bx
    73 00000211 51                  <1>     push    cx
    74 00000212 52                  <1>     push    dx
    75 00000213 56                  <1>     push    si
    76 00000214 57                  <1>     push    di
    77                              <1> 
    78 00000215 8B4604              <1>     mov     ax, [bp + 4]
    79 00000218 8B7606              <1>     mov     si, [bp + 6]
    80 0000021B 8B4E08              <1>     mov     cx, [bp + 8]
    81                              <1> 
    82 0000021E 89F7                <1>     mov     di, si
    83 00000220 01CF                <1>     add     di, cx
    84 00000222 4F                  <1>     dec     di
    85                              <1> 
    86 00000223 8B5E0C              <1>     mov     bx, word [bp + 12]
    87                              <1> 
    88 00000226 F7C30100            <1>     test    bx, 0b0001
    89                              <1> .10Q:
    90 0000022A 7408                <1>     je      .10E
    91 0000022C 83F800              <1>     cmp     ax, 0
    92                              <1> .12Q:
    93 0000022F 7D03                <1>     jge     .12E
    94 00000231 83CB02              <1>     or      bx, 0b0010
    95                              <1> .12E:
    96                              <1> .10E:
    97                              <1> 
    98 00000234 F7C30200            <1>     test    bx, 0b0010
    99                              <1> .20Q:
   100 00000238 7410                <1>     je      .20E
   101 0000023A 83F800              <1>     cmp     ax, 0
   102                              <1> .22Q:
   103 0000023D 7D07                <1>     jge     .22F
   104 0000023F F7D8                <1>     neg     ax
   105 00000241 C6042D              <1>     mov     [si], byte '-'
   106 00000244 EB03                <1>     jmp     .22E
   107                              <1> .22F:
   108 00000246 C6042B              <1>     mov     [si], byte '+'
   109                              <1> .22E:
   110 00000249 49                  <1>     dec     cx
   111                              <1> .20E:
   112 0000024A 8B5E0A              <1>     mov     bx, [bp + 10]
   113                              <1> .30L:
   114 0000024D BA0000              <1>     mov     dx, 0
   115 00000250 F7F3                <1>     div     bx
   116 00000252 89D6                <1>     mov     si, dx
   117 00000254 8A94[7C02]          <1>     mov     dl, byte [.ascii+si]
   118 00000258 8815                <1>     mov     [di], dl
   119 0000025A 4F                  <1>     dec     di
   120                              <1> 
   121 0000025B 83F800              <1>     cmp     ax, 0
   122 0000025E E0ED                <1>     loopnz  .30L
   123                              <1> .30E:
   124                              <1> 
   125 00000260 83F900              <1>     cmp     cx, 0
   126                              <1> .40Q:
   127 00000263 740D                <1>     je      .40E
   128 00000265 B020                <1>     mov     al, ' '
   129 00000267 837E0C04            <1>     cmp     [bp + 12], word 0b0100
   130                              <1> .42Q:
   131 0000026B 7502                <1>     jne     .42E
   132 0000026D B030                <1>     mov     al, '0'
   133                              <1> .42E:
   134 0000026F FD                  <1>     std
   135 00000270 F3AA                <1>     rep     stosb
   136                              <1> .40E:
   137 00000272 5F                  <1>     pop     di
   138 00000273 5E                  <1>     pop     si
   139 00000274 5A                  <1>     pop     dx
   140 00000275 59                  <1>     pop     cx
   141 00000276 5B                  <1>     pop     bx
   142 00000277 58                  <1>     pop     ax
   143                              <1> 
   144 00000278 89EC                <1>     mov     sp, bp
   145 0000027A 5D                  <1>     pop     bp
   146                              <1> 
   147 0000027B C3                  <1>     ret
   148                              <1> 
   149 0000027C 303132333435363738- <1> .ascii  db  "0123456789ABCDEF"
   149 00000285 39414243444546      <1>
    67                                  %include    "../modules/real/get_drive_param.s"
    68                              <1> get_drive_param:
    69 0000028C 55                  <1>     push    bp
    70 0000028D 89E5                <1>     mov     bp, sp
    71                              <1> 
    72 0000028F 53                  <1>     push    bx
    73 00000290 51                  <1>     push    cx
    74 00000291 06                  <1>     push    es
    75 00000292 56                  <1>     push    si
    76 00000293 57                  <1>     push    di
    77                              <1> 
    78 00000294 8B7604              <1>     mov     si, [bp + 4]
    79                              <1> 
    80 00000297 B80000              <1>     mov     ax, 0
    81 0000029A 8EC0                <1>     mov     es, ax
    82 0000029C 89C7                <1>     mov     di, ax
    83                              <1> 
    84 0000029E B408                <1>     mov     ah, 8
    85 000002A0 8A14                <1>     mov     dl, [si + drive.no]
    86 000002A2 CD13                <1>     int     0x13
    87                              <1> .10Q:
    88 000002A4 721B                <1>     jc      .10F
    89                              <1> .10T:
    90 000002A6 88C8                <1>     mov     al, cl
    91 000002A8 83E03F              <1>     and     ax, 0x3F
    92                              <1> 
    93 000002AB C0E906              <1>     shr     cl, 6
    94 000002AE C1C908              <1>     ror     cx, 8
    95 000002B1 41                  <1>     inc     cx
    96                              <1> 
    97 000002B2 0FB6DE              <1>     movzx   bx, dh
    98 000002B5 43                  <1>     inc     bx
    99                              <1> 
   100 000002B6 894C02              <1>     mov     [si + drive.cyln], cx
   101 000002B9 895C04              <1>     mov     [si + drive.head], bx
   102 000002BC 894406              <1>     mov     [si + drive.sect], ax
   103                              <1> 
   104 000002BF EB03                <1>     jmp     .10E
   105                              <1> .10F:
   106 000002C1 B80000              <1>     mov     ax, 0
   107                              <1> .10E:
   108 000002C4 5F                  <1>     pop     di
   109 000002C5 5E                  <1>     pop     si
   110 000002C6 07                  <1>     pop     es
   111 000002C7 59                  <1>     pop     cx
   112 000002C8 5B                  <1>     pop     bx
   113                              <1> 
   114 000002C9 89EC                <1>     mov     sp, bp
   115 000002CB 5D                  <1>     pop     bp
   116 000002CC C3                  <1>     ret
    68                                  %include    "../modules/real/get_font_adr.s"
    69                              <1> get_font_adr:
    70 000002CD 55                  <1>     push    bp
    71 000002CE 89E5                <1>     mov     bp, sp
    72                              <1> 
    73 000002D0 50                  <1>     push    ax
    74 000002D1 53                  <1>     push    bx
    75 000002D2 56                  <1>     push    si
    76 000002D3 06                  <1>     push    es
    77 000002D4 55                  <1>     push    bp
    78                              <1> 
    79 000002D5 8B7604              <1>     mov     si, [bp + 4]
    80                              <1> 
    81 000002D8 B83011              <1>     mov     ax, 0x1130
    82 000002DB B706                <1>     mov     bh, 0x06
    83 000002DD CD10                <1>     int     10h
    84                              <1> 
    85 000002DF 8C04                <1>     mov     [si + 0], es
    86 000002E1 896C02              <1>     mov     [si + 2], bp
    87                              <1> 
    88 000002E4 5D                  <1>     pop     bp
    89 000002E5 07                  <1>     pop     es
    90 000002E6 5E                  <1>     pop     si
    91 000002E7 5B                  <1>     pop     bx
    92 000002E8 58                  <1>     pop     ax
    93                              <1> 
    94 000002E9 89EC                <1>     mov     sp, bp
    95 000002EB 5D                  <1>     pop     bp
    96                              <1> 
    97 000002EC C3                  <1>     ret
    69                                  %include    "../modules/real/get_mem_info.s"
    70                              <1> get_mem_info:
    71 000002ED 6650                <1>     push    eax
    72 000002EF 6653                <1>     push    ebx
    73 000002F1 6651                <1>     push    ecx
    74 000002F3 6652                <1>     push    edx
    75 000002F5 56                  <1>     push    si
    76 000002F6 57                  <1>     push    di
    77 000002F7 55                  <1>     push    bp
    78                              <1> 
    79 000002F8 68[8C03]E8D0FD83C4- <1>     cdecl   puts, .s0
    79 00000300 02                  <1>
    80                              <1> 
    81 00000301 BD0000              <1>     mov     bp, 0
    82 00000304 66BB00000000        <1>     mov     ebx, 0
    83                              <1> 
    84                              <1> .10L:
    85 0000030A 66B820E80000        <1>     mov     eax, 0x0000E820
    86 00000310 66B914000000        <1>     mov     ecx, E820_RECORD_SIZE
    87 00000316 66BA50414D53        <1>     mov     edx, 'PAMS'
    88 0000031C BF[1804]            <1>     mov     di, .b0
    89 0000031F CD15                <1>     int     0x15
    90                              <1> 
    91 00000321 663D50414D53        <1>     cmp     eax, 'PAMS'
    92 00000327 7402                <1>     je      .12E
    93 00000329 EB4C                <1>     jmp     .10E
    94                              <1> .12E:
    95 0000032B 7302                <1>     jnc     .14E
    96 0000032D EB48                <1>     jmp     .10E
    97                              <1> .14E:
    98 0000032F 57E8F90083C402      <1>     cdecl   put_mem_info, di
    99                              <1> 
   100 00000336 668B4510            <1>     mov     eax, [di + 16]
   101 0000033A 6683F803            <1>     cmp     eax, 3
   102 0000033E 750F                <1>     jne     .15E
   103                              <1> 
   104 00000340 668B05              <1>     mov     eax, [di + 0]
   105 00000343 66A3[0402]          <1>     mov     [ACPI_DATA.adr], eax
   106                              <1> 
   107 00000347 668B4508            <1>     mov     eax, [di + 8]
   108 0000034B 66A3[0802]          <1>     mov     [ACPI_DATA.len], eax
   109                              <1> 
   110                              <1> .15E:
   111 0000034F 6683FB00            <1>     cmp     ebx, 0
   112 00000353 741C                <1>     jz      .16E
   113                              <1> 
   114 00000355 45                  <1>     inc     bp
   115 00000356 83E507              <1>     and     bp, 0x07
   116 00000359 7516                <1>     jnz     .16E
   117                              <1> 
   118 0000035B 68[FF03]E86DFD83C4- <1>     cdecl   puts, .s2
   118 00000363 02                  <1>
   119                              <1> 
   120 00000364 B410                <1>     mov     ah, 0x10
   121 00000366 CD16                <1>     int     0x16
   122                              <1> 
   123 00000368 68[0904]E860FD83C4- <1>     cdecl   puts, .s3
   123 00000370 02                  <1>
   124                              <1> 
   125                              <1> .16E:
   126 00000371 6683FB00            <1>     cmp     ebx, 0
   127 00000375 7593                <1>     jne     .10L
   128                              <1> 
   129                              <1> .10E:
   130 00000377 68[CF03]E851FD83C4- <1>     cdecl   puts, .s1
   130 0000037F 02                  <1>
   131                              <1> 
   132 00000380 5D                  <1>     pop     bp
   133 00000381 5F                  <1>     pop     di
   134 00000382 5E                  <1>     pop     si
   135 00000383 665A                <1>     pop     edx
   136 00000385 6659                <1>     pop     ecx
   137 00000387 665B                <1>     pop     ebx
   138 00000389 6658                <1>     pop     eax
   139                              <1> 
   140 0000038B C3                  <1>     ret
   141                              <1> 
   142                              <1> 
   143 0000038C 2045383230204D656D- <1> .s0 db " E820 Memory Map:", 0x0A, 0x0D
   143 00000395 6F7279204D61703A0A- <1>
   143 0000039E 0D                  <1>
   144 0000039F 20426173655F5F5F5F- <1>     db " Base_____________ Length___________ Type____", 0x0A, 0x0D, 0
   144 000003A8 5F5F5F5F5F5F5F5F5F- <1>
   144 000003B1 204C656E6774685F5F- <1>
   144 000003BA 5F5F5F5F5F5F5F5F5F- <1>
   144 000003C3 20547970655F5F5F5F- <1>
   144 000003CC 0A0D00              <1>
   145 000003CF 202D2D2D2D2D2D2D2D- <1> .s1 db  " ----------------- ----------------- --------", 0x0A, 0x0D, 0
   145 000003D8 2D2D2D2D2D2D2D2D2D- <1>
   145 000003E1 202D2D2D2D2D2D2D2D- <1>
   145 000003EA 2D2D2D2D2D2D2D2D2D- <1>
   145 000003F3 202D2D2D2D2D2D2D2D- <1>
   145 000003FC 0A0D00              <1>
   146 000003FF 3C6D6F72652E2E2E3E- <1> .s2 db  "<more...>", 0
   146 00000408 00                  <1>
   147 00000409 0D2020202020202020- <1> .s3 db  0x0D, "         ", 0x0D, 0
   147 00000412 200D00              <1>
   148                              <1> 
   149                              <1> 
   150 00000415 00<rep 3h>          <1> ALIGN 4, db 0
   151 00000418 00<rep 14h>         <1> .b0:    times E820_RECORD_SIZE db 0
   152                              <1> 
   153                              <1> 
   154                              <1> 
   155                              <1> put_mem_info:
   156 0000042C 55                  <1>     push    bp
   157 0000042D 89E5                <1>     mov     bp, sp
   158                              <1> 
   159 0000042F 53                  <1>     push    bx
   160 00000430 56                  <1>     push    si
   161                              <1> 
   162 00000431 8B7604              <1>     mov     si, [bp + 4]
   163                              <1> 
   164 00000434 6A046A106A0468-     <1>     cdecl   itoa, word [si + 6], .p2+0, 4, 16, 0b0100
   164 0000043B [0B05]FF7406E8C9FD- <1>
   164 00000443 83C40A              <1>
   165 00000446 6A046A106A0468-     <1>     cdecl   itoa, word [si + 4], .p2+4, 4, 16, 0b0100
   165 0000044D [0F05]FF7404E8B7FD- <1>
   165 00000455 83C40A              <1>
   166 00000458 6A046A106A0468-     <1>     cdecl   itoa, word [si + 2], .p3+0, 4, 16, 0b0100
   166 0000045F [1405]FF7402E8A5FD- <1>
   166 00000467 83C40A              <1>
   167 0000046A 6A046A106A0468-     <1>     cdecl   itoa, word [si + 0], .p3+4, 4, 16, 0b0100
   167 00000471 [1805]FF34E894FD83- <1>
   167 00000479 C40A                <1>
   168                              <1> 
   169 0000047B 6A046A106A0468-     <1>     cdecl   itoa, word [si + 14], .p4+0, 4, 16, 0b0100
   169 00000482 [1D05]FF740EE882FD- <1>
   169 0000048A 83C40A              <1>
   170 0000048D 6A046A106A0468-     <1>     cdecl   itoa, word [si + 12], .p4+4, 4, 16, 0b0100
   170 00000494 [2105]FF740CE870FD- <1>
   170 0000049C 83C40A              <1>
   171 0000049F 6A046A106A0468-     <1>     cdecl   itoa, word [si + 10], .p5+0, 4, 16, 0b0100
   171 000004A6 [2605]FF740AE85EFD- <1>
   171 000004AE 83C40A              <1>
   172 000004B1 6A046A106A0468-     <1>     cdecl   itoa, word [si +  8], .p5+4, 4, 16, 0b0100
   172 000004B8 [2A05]FF7408E84CFD- <1>
   172 000004C0 83C40A              <1>
   173                              <1> 
   174 000004C3 6A046A106A0468-     <1>     cdecl   itoa, word [si + 18], .p6+0, 4, 16, 0b0100
   174 000004CA [2F05]FF7412E83AFD- <1>
   174 000004D2 83C40A              <1>
   175 000004D5 6A046A106A0468-     <1>     cdecl   itoa, word [si + 16], .p6+4, 4, 16, 0b0100
   175 000004DC [3305]FF7410E828FD- <1>
   175 000004E4 83C40A              <1>
   176                              <1> 
   177 000004E7 68[0A05]E8E1FB83C4- <1>     cdecl   puts, .s1
   177 000004EF 02                  <1>
   178                              <1> 
   179 000004F0 8B5C10              <1>     mov     bx, [si + 16]
   180 000004F3 83E307              <1>     and     bx, 0x07
   181 000004F6 D1E3                <1>     shl     bx, 1
   182 000004F8 81C3[8C05]          <1>     add     bx, .t0
   183 000004FC FF37E8CDFB83C402    <1>     cdecl   puts, word [bx]
   184                              <1> 
   185 00000504 5E                  <1>     pop     si
   186 00000505 5B                  <1>     pop     bx
   187                              <1> 
   188 00000506 89EC                <1>     mov     sp, bp
   189 00000508 5D                  <1>     pop     bp
   190                              <1> 
   191 00000509 C3                  <1>     ret
   192                              <1> 
   193                              <1> 
   194                              <1> 
   195 0000050A 20                  <1> .s1 db  " "
   196 0000050B 5A5A5A5A5A5A5A5A5F  <1> .p2 db  "ZZZZZZZZ_"
   197 00000514 5A5A5A5A5A5A5A5A20  <1> .p3 db  "ZZZZZZZZ "
   198 0000051D 5A5A5A5A5A5A5A5A5F  <1> .p4 db  "ZZZZZZZZ_"
   199 00000526 5A5A5A5A5A5A5A5A20  <1> .p5 db  "ZZZZZZZZ "
   200 0000052F 5A5A5A5A5A5A5A5A00  <1> .p6 db  "ZZZZZZZZ", 0
   201                              <1> 
   202 00000538 2028556E6B6E6F776E- <1> .s4 db  " (Unknown)", 0x0A, 0x0D, 0
   202 00000541 290A0D00            <1>
   203 00000545 2028757361626C6529- <1> .s5 db  " (usable)", 0x0A, 0x0D, 0
   203 0000054E 0A0D00              <1>
   204 00000551 202872657365727665- <1> .s6 db  " (reserved)", 0x0A, 0x0D, 0
   204 0000055A 64290A0D00          <1>
   205 0000055F 202841435049206461- <1> .s7 db  " (ACPI data)", 0x0A, 0x0D, 0
   205 00000568 7461290A0D00        <1>
   206 0000056E 202841435049204E56- <1> .s8 db  " (ACPI NVS)", 0x0A, 0x0D, 0
   206 00000577 53290A0D00          <1>
   207 0000057C 2028626164206D656D- <1> .s9 db  " (bad memory)", 0x0A, 0x0D, 0
   207 00000585 6F7279290A0D00      <1>
   208                              <1> 
   209 0000058C [3805][4505][5105]- <1> .t0 dw  .s4, .s5, .s6, .s7, .s8, .s9, .s4, .s4
   209 00000592 [5F05][6E05][7C05]- <1>
   209 00000598 [3805][3805]        <1>
    70                                  %include    "../modules/real/kbc.s"
    71                              <1> KBC_Data_Write:
    72 0000059C 55                  <1>     push    bp
    73 0000059D 89E5                <1>     mov     bp, sp
    74                              <1> 
    75 0000059F 51                  <1>     push    cx
    76                              <1> 
    77 000005A0 B90000              <1>     mov     cx, 0
    78                              <1> 
    79                              <1> .10L:
    80 000005A3 E464                <1>     in      al, 0x64
    81 000005A5 A802                <1>     test    al, 0x02
    82 000005A7 E0FA                <1>     loopnz  .10L
    83                              <1>     
    84 000005A9 83F900              <1>     cmp     cx, 0
    85 000005AC 7405                <1>     jz      .20E
    86                              <1> 
    87 000005AE 8A4604              <1>     mov     al, [bp + 4]
    88 000005B1 E660                <1>     out     0x60, al
    89                              <1> 
    90                              <1> .20E:
    91 000005B3 89C8                <1>     mov     ax, cx
    92                              <1> 
    93 000005B5 59                  <1>     pop     cx
    94                              <1> 
    95 000005B6 89EC                <1>     mov     sp, bp
    96 000005B8 5D                  <1>     pop     bp
    97                              <1> 
    98 000005B9 C3                  <1>     ret
    99                              <1> 
   100                              <1> KBC_Data_Read:
   101 000005BA 55                  <1>     push    bp
   102 000005BB 89E5                <1>     mov     bp, sp
   103                              <1> 
   104 000005BD 51                  <1>     push    cx
   105                              <1> 
   106 000005BE B90000              <1>     mov     cx, 0
   107                              <1> 
   108                              <1> .10L:
   109 000005C1 E464                <1>     in      al, 0x64
   110 000005C3 A801                <1>     test    al, 0x01
   111 000005C5 E1FA                <1>     loopz   .10L
   112                              <1> 
   113 000005C7 83F900              <1>     cmp     cx, 0
   114 000005CA 7409                <1>     jz      .20E
   115                              <1> 
   116 000005CC B400                <1>     mov     ah, 0x00
   117 000005CE E460                <1>     in      al, 0x60
   118                              <1> 
   119 000005D0 8B7E04              <1>     mov     di, [bp + 4]
   120 000005D3 8905                <1>     mov     [di + 0], ax
   121                              <1> 
   122                              <1> .20E:
   123 000005D5 89C8                <1>     mov     ax, cx
   124                              <1> 
   125 000005D7 59                  <1>     pop     cx
   126                              <1> 
   127 000005D8 89EC                <1>     mov     sp, bp
   128 000005DA 5D                  <1>     pop     bp
   129                              <1> 
   130 000005DB C3                  <1>     ret
   131                              <1> 
   132                              <1> KBC_Cmd_Write:
   133 000005DC 55                  <1>     push    bp
   134 000005DD 89E5                <1>     mov     bp, sp
   135                              <1> 
   136 000005DF 51                  <1>     push    cx
   137                              <1> 
   138 000005E0 B90000              <1>     mov     cx, 0
   139                              <1> 
   140                              <1> .10L:
   141 000005E3 E464                <1>     in      al, 0x64
   142 000005E5 A802                <1>     test    al, 0x02
   143 000005E7 E0FA                <1>     loopnz  .10L
   144                              <1>     
   145 000005E9 83F900              <1>     cmp     cx, 0
   146 000005EC 7405                <1>     jz      .20E
   147                              <1> 
   148 000005EE 8A4604              <1>     mov     al, [bp + 4]
   149 000005F1 E664                <1>     out     0x64, al
   150                              <1> 
   151                              <1> .20E:
   152 000005F3 89C8                <1>     mov     ax, cx
   153                              <1> 
   154 000005F5 59                  <1>     pop     cx
   155                              <1> 
   156 000005F6 89EC                <1>     mov     sp, bp
   157 000005F8 5D                  <1>     pop     bp
   158                              <1> 
   159 000005F9 C3                  <1>     ret
    71                                  
    72                                  stage_2:
    73 000005FA 68[7406]E8CEFA83C4-         cdecl   puts, .s0
    73 00000602 02                 
    74                                  
    75 00000603 68[C400]E883FC83C4-         cdecl   get_drive_param, BOOT
    75 0000060B 02                 
    76 0000060C 83F800                      cmp     ax, 0
    77                                  .10Q:
    78 0000060F 750C                        jne     .10E
    79                                  .10T:
    80 00000611 68[AB06]E8B7FA83C4-         cdecl   puts, .e0
    80 00000619 02                 
    81 0000061A E8D0FA                      call    reboot
    82                                  .10E:
    83 0000061D A1[C400]                    mov     ax, [BOOT + drive.no]
    84 00000620 6A046A106A0268-             cdecl   itoa, ax, .p1, 2, 16, 0b0100
    84 00000627 [8C06]50E8DFFB83C4-
    84 0000062F 0A                 
    85 00000630 A1[C600]                    mov     ax, [BOOT + drive.cyln]
    86 00000633 6A046A106A0468-             cdecl   itoa, ax, .p2, 4, 16, 0b0100
    86 0000063A [9406]50E8CCFB83C4-
    86 00000642 0A                 
    87 00000643 A1[C800]                    mov     ax, [BOOT + drive.head]
    88 00000646 6A046A106A0268-             cdecl   itoa, ax, .p3, 2, 16, 0b0100
    88 0000064D [9E06]50E8B9FB83C4-
    88 00000655 0A                 
    89 00000656 A1[CA00]                    mov     ax, [BOOT + drive.sect]
    90 00000659 6A046A106A0268-             cdecl   itoa, ax, .p4, 2, 16, 0b0100
    90 00000660 [A606]50E8A6FB83C4-
    90 00000668 0A                 
    91 00000669 68[8306]E85FFA83C4-         cdecl   puts, .s1
    91 00000671 02                 
    92                                  
    93 00000672 EB52                        jmp     stage_3rd
    94                                  
    95 00000674 326E64207374616765-     .s0 db  "2nd stage...", 0x0A, 0x0D, 0
    95 0000067D 2E2E2E0A0D00       
    96                                  
    97 00000683 2044726976653A3078      .s1 db  " Drive:0x"
    98 0000068C 20202C20433A3078        .p1 db  "  , C:0x"
    99 00000694 202020202C20483A30-     .p2 db  "    , H:0x"
    99 0000069D 78                 
   100 0000069E 20202C20533A3078        .p3 db  "  , S:0x"
   101 000006A6 20200A0D00              .p4 db  "  ", 0x0A, 0x0D, 0
   102                                  
   103 000006AB 43616E277420676574-     .e0 db  "Can't get drive parameter.", 0
   103 000006B4 206472697665207061-
   103 000006BD 72616D657465722E00 
   104                                  
   105                                  stage_3rd:
   106 000006C6 68[4307]E802FA83C4-         cdecl   puts, .s0
   106 000006CE 02                 
   107 000006CF 68[0002]E8F8FB83C4-         cdecl   get_font_adr, FONT
   107 000006D7 02                 
   108 000006D8 6A046A106A0468-             cdecl   itoa, word [FONT.seg], .p1, 4, 16, 0b0100
   108 000006DF [6007]FF36[0002]E8-
   108 000006E6 24FB83C40A         
   109 000006EB 6A046A106A0468-             cdecl   itoa, word [FONT.off], .p2, 4, 16, 0b0100
   109 000006F2 [6507]FF36[0202]E8-
   109 000006F9 11FB83C40A         
   110 000006FE 68[5207]E8CAF983C4-         cdecl   puts, .s1
   110 00000706 02                 
   111                                  
   112 00000707 E8E3FB                      cdecl   get_mem_info
   113                                  
   114 0000070A 66A1[0402]                  mov     eax, [ACPI_DATA.adr]
   115 0000070E 6683F800                    cmp     eax, 0
   116 00000712 742D                        je      .10E
   117                                  
   118 00000714 6A046A106A0468-             cdecl   itoa, ax, .p4, 4, 16, 0b0100
   118 0000071B [7E07]50E8EBFA83C4-
   118 00000723 0A                 
   119 00000724 66C1E810                    shr     eax, 16
   120 00000728 6A046A106A0468-             cdecl   itoa, ax, .p3, 4, 16, 0b0100
   120 0000072F [7A07]50E8D7FA83C4-
   120 00000737 0A                 
   121 00000738 68[6F07]E890F983C4-         cdecl   puts, .s2
   121 00000740 02                 
   122                                  
   123                                  .10E:
   124 00000741 EB42                        jmp     stage_4
   125                                  
   126 00000743 337264207374616765-     .s0 db  "3rd stage...", 0x0A, 0x0D, 0
   126 0000074C 2E2E2E0A0D00       
   127                                  
   128 00000752 20466F6E7420416464-     .s1 db  " Font Address="
   128 0000075B 726573733D         
   129 00000760 5A5A5A5A3A              .p1 db  "ZZZZ:"
   130 00000765 5A5A5A5A0A0D00          .p2 db  "ZZZZ", 0x0A, 0x0D, 0
   131 0000076C 0A0D00                      db  0x0A, 0x0D, 0
   132                                  
   133 0000076F 204143504920646174-     .s2 db  " ACPI data="
   133 00000778 613D               
   134 0000077A 5A5A5A5A                .p3 db  "ZZZZ"
   135 0000077E 5A5A5A5A0A0D00          .p4 db  "ZZZZ", 0x0A, 0x0D, 0
   136                                  
   137                                  stage_4:
   138 00000785 68[D607]E843F983C4-         cdecl   puts, .s0
   138 0000078D 02                 
   139                                  
   140 0000078E FA                          cli
   141                                  
   142 0000078F 68AD00E847FE83C402          cdecl   KBC_Cmd_Write, 0xAD
   143 00000798 68D000E83EFE83C402          cdecl   KBC_Cmd_Write, 0xD0
   144 000007A1 68[FA07]E813FE83C4-         cdecl   KBC_Data_Read, .key
   144 000007A9 02                 
   145                                  
   146 000007AA 8A1E[FA07]                  mov     bl, [.key]
   147 000007AE 80CB02                      or      bl, 0x02
   148                                  
   149 000007B1 68D100E825FE83C402          cdecl   KBC_Cmd_Write, 0xD1
   150 000007BA 53E8DEFD83C402              cdecl   KBC_Data_Write, bx
   151                                  
   152 000007C1 68AE00E815FE83C402          cdecl   KBC_Cmd_Write, 0xAE
   153                                  
   154 000007CA FB                          sti
   155                                      
   156 000007CB 68[E507]E8FDF883C4-         cdecl   puts, .s1
   156 000007D3 02                 
   157                                  
   158 000007D4 EBFE                        jmp     $
   159                                  
   160 000007D6 347468207374616765-     .s0 db  "4th stage...", 0x0A, 0x0D, 0
   160 000007DF 2E2E2E0A0D00       
   161 000007E5 204132302047617465-     .s1 db  " A20 Gate Enabled.", 0x0A, 0x0D, 0
   161 000007EE 20456E61626C65642E-
   161 000007F7 0A0D00             
   162 000007FA 0000                    .key    dw  0
   163                                  
   164                                  
   165                                  
   166 000007FC 00<rep 1804h>               times BOOT_SIZE - ($ - $$)   db  0
